<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Economic Calendar | WabbleNews</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        const CONFIG = {
            CALENDAR_API_KEY: '8572343ae727904ed9d2823906f35fb18680bd98fe4fcdf759caf77d9ad9db00',
            CALENDAR_API_URL: 'https://financeflowapi.com/api/v1/financial-calendar'
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #020204; color: white; font-family: 'Montserrat', sans-serif; font-weight: 700; -webkit-font-smoothing: antialiased; overflow-x: hidden; }

        /* Mobile Menu */
        .mobile-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); backdrop-filter: blur(20px); z-index: 9999; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .mobile-menu.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .mobile-menu-content { padding: 20px; height: 100%; display: flex; flex-direction: column; }
        .mobile-menu-close { align-self: flex-end; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 12px; padding: 12px; color: white; cursor: pointer; }
        .mobile-menu-close:hover { background: rgba(255, 255, 255, 0.2); }
        .mobile-nav { display: flex; flex-direction: column; gap: 8px; margin-top: 40px; }
        .mobile-nav-link { padding: 16px 20px; color: white; text-decoration: none; font-weight: 700; font-size: 18px; border-radius: 12px; }
        .mobile-nav-link:hover, .mobile-nav-link.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .mobile-nav-link.signup-link { background: linear-gradient(135deg, #3b82f6, #2563eb); text-align: center; margin-top: 20px; }
        .mobile-profile-btn { display: flex; align-items: center; gap: 12px; padding: 16px 20px; color: white; font-weight: 700; font-size: 18px; border-radius: 12px; cursor: pointer; background: rgba(59, 130, 246, 0.2); margin-top: 20px; }
        .mobile-profile-btn.hidden { display: none; }

        header { background: rgba(0, 0, 0, 0.98); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }

        .logo-container { position: relative; display: flex; align-items: center; gap: 12px; }
        .logo-circle { width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); border: 2px solid rgba(59, 130, 246, 0.5); overflow: hidden; }
        .logo-circle img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .logo-text { font-size: 24px; font-weight: 900; letter-spacing: -0.5px; background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text .blue { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        nav a { color: rgba(255, 255, 255, 0.7); text-decoration: none; font-size: 14px; font-weight: 700; transition: color 0.3s ease; }
        nav a:hover { color: #60a5fa; }

        .settings-bar { background: rgba(10, 10, 15, 0.95); border-bottom: 1px solid rgba(255, 255, 255, 0.08); padding: 8px 0; }
        .settings-dropdown { position: relative; display: inline-block; }
        .settings-btn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #9ca3af; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
        .settings-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; border-color: rgba(59, 130, 246, 0.5); }
        .settings-btn i { width: 14px; height: 14px; }
        .dropdown-menu { position: absolute; top: 100%; left: 0; margin-top: 4px; background: rgba(15, 15, 20, 0.98); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; min-width: 200px; max-height: 300px; overflow-y: auto; z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); }
        .dropdown-menu.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; color: #9ca3af; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .dropdown-item:hover { background: rgba(59, 130, 246, 0.1); color: white; }
        .dropdown-item.selected { color: #60a5fa; background: rgba(59, 130, 246, 0.1); }

        .calendar-container { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; overflow: hidden; }

        .calendar-header { background: rgba(255, 255, 255, 0.03); padding: 20px 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
        .calendar-title { font-size: 20px; font-weight: 900; color: white; }
        .calendar-nav { display: flex; align-items: center; gap: 12px; }
        .nav-btn { padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: #9ca3af; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
        .nav-btn:hover { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .nav-btn.active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #60a5fa; }

        .event-list { padding: 0; }
        .event-day { border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .event-day:last-child { border-bottom: none; }
        .day-header { padding: 16px 24px; background: rgba(255, 255, 255, 0.02); font-size: 14px; font-weight: 800; color: #60a5fa; }

        .event-item { display: grid; grid-template-columns: 100px 1fr 100px 80px; align-items: center; padding: 16px 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.03); transition: all 0.3s ease; gap: 16px; }
        .event-item:hover { background: rgba(255, 255, 255, 0.03); }
        .event-item:last-child { border-bottom: none; }

        .event-time { font-size: 13px; font-weight: 800; color: #9ca3af; }
        .event-details { display: flex; flex-direction: column; gap: 4px; }
        .event-name { font-size: 14px; font-weight: 800; color: white; }
        .event-country { font-size: 12px; font-weight: 700; color: #6b7280; display: flex; align-items: center; gap: 6px; }
        .event-country img { width: 16px; height: 12px; border-radius: 2px; }

        .event-forecast { font-size: 13px; font-weight: 700; color: #9ca3af; text-align: center; }
        .event-impact { display: flex; justify-content: center; }
        .impact-dot { width: 10px; height: 10px; border-radius: 50%; }
        .impact-low { background: #eab308; }
        .impact-medium { background: #f97316; }
        .impact-high { background: #ef4444; }

        /* Filters */
        .filters-bar { display: flex; flex-wrap: wrap; gap: 12px; padding: 16px 24px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.06); }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-size: 12px; font-weight: 700; color: #6b7280; }
        .filter-btn { padding: 6px 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #9ca3af; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; }
        .filter-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .filter-btn.active { background: rgba(9, 177, 248, 0.2); border-color: #09B1F8; color: #09B1F8; }
        .filter-btn img { width: 16px; height: 12px; border-radius: 2px; }
        .impact-indicator { width: 8px; height: 8px; border-radius: 50%; }

        /* Countdown */
        .event-countdown { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; font-size: 11px; font-weight: 800; color: #ef4444; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .event-item.upcoming { background: rgba(239, 68, 68, 0.05); border-left: 3px solid #ef4444; }
        .event-item.released { opacity: 0.6; }
        .event-actual { font-weight: 900; color: #22c55e; }
        .event-actual.negative { color: #ef4444; }

        /* Historical data */
        .event-history { margin-top: 8px; display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
        .history-item { padding: 4px 8px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 6px; font-size: 10px; font-weight: 700; color: #6b7280; white-space: nowrap; flex-shrink: 0; }
        .history-item span { color: #9ca3af; }

        /* Notification badge */
        .notification-toggle { position: relative; }
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; }

        .no-events { padding: 60px 24px; text-align: center; color: #6b7280; font-size: 14px; }

        @media (max-width: 768px) {
            .event-item { grid-template-columns: 1fr; gap: 12px; }
            .event-time { order: -1; }
            .event-forecast, .event-impact { justify-content: flex-start; }
            .calendar-header { flex-direction: column; align-items: flex-start; }
        }

        .signup-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 1000; align-items: center; justify-content: center; }
        .signup-modal.active { display: flex; }
        .signup-content { background: rgba(15, 15, 25, 0.98); border: 2px solid rgba(59, 130, 246, 0.5); border-radius: 24px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 0 50px rgba(59, 130, 246, 0.3); position: relative; }
        .signup-content h2 { font-weight: 900; font-size: 28px; margin-bottom: 8px; background: linear-gradient(135deg, #ffffff 0%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .signup-content p { color: #9ca3af; font-size: 14px; margin-bottom: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 700; font-size: 14px; margin-bottom: 8px; color: #e5e7eb; }
        .form-group input { width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: white; font-size: 15px; font-weight: 700; transition: all 0.3s ease; }
        .form-group input:focus { outline: none; border-color: #3b82f6; background: rgba(255, 255, 255, 0.08); }
        .signup-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 12px; color: white; font-weight: 900; font-size: 16px; cursor: pointer; transition: all 0.3s ease; margin-top: 8px; }
        .signup-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); }
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .close-btn:hover { background: rgba(255, 255, 255, 0.2); transform: rotate(90deg); }
        .error-message { color: #ef4444; font-size: 12px; margin-top: 6px; font-weight: 700; display: none; }
        .error-message.show { display: block; }
        .toggle-link { color: #ffffff; font-size: 14px; font-weight: 700; text-align: center; margin-top: 16px; }
        .toggle-link .sign-in-link, .toggle-link .sign-up-link { color: #3b82f6; cursor: pointer; font-weight: 700; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="logo-container cursor-pointer hover:opacity-90 transition-opacity" onclick="window.location.href='index.html'">
                <div class="logo-circle">
                    <img src="wabble.jpg" alt="WabbleNews Logo">
                </div>
                <span class="logo-text">Wabble<span class="blue">News</span></span>
            </div>

            <nav class="hidden lg:flex items-center gap-6">
                <a href="index.html" class="text-sm font-bold text-white" data-translate="home">Home</a>
                <a href="contact.html" class="text-sm font-bold text-white" data-translate="contact">Contact</a>
                <a href="social-media.html" class="text-sm font-bold text-white" data-translate="social">Social Media</a>
                <a href="calendar.html" class="text-sm font-bold text-blue-400" data-translate="calendar">Calendar</a>
                <a href="#" id="signUpBtn" onclick="openAuthModal('signup'); return false;" class="text-sm font-bold bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors cursor-pointer" data-translate="signup">Sign Up/Sign In</a>
                <div id="profileBtn" class="hidden cursor-pointer" onclick="openProfileModal()">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center border-2 border-blue-400 overflow-hidden">
                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                    </div>
                </div>
            </nav>

            <button onclick="toggleMenu()" class="lg:hidden p-2 rounded-lg hover:bg-white/10 text-white">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu hidden">
        <div class="mobile-menu-content">
            <button onclick="toggleMenu()" class="mobile-menu-close">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <nav class="mobile-nav">
                <a href="index.html" class="mobile-nav-link">Home</a>
                <a href="contact.html" class="mobile-nav-link">Contact</a>
                <a href="social-media.html" class="mobile-nav-link">Social Media</a>
                <a href="calendar.html" class="mobile-nav-link active">Calendar</a>
                <a href="#" id="mobileSignUpBtn" onclick="openAuthModal(); toggleMenu(); return false;" class="mobile-nav-link signup-link">Sign Up/Sign In</a>
                <div id="mobileProfileBtn" class="mobile-profile-btn hidden" onclick="openProfileModal(); toggleMenu();">
                    <i data-lucide="user" class="w-5 h-5"></i>
                    <span>Profile</span>
                </div>
            </nav>
        </div>
    </div>

    <div class="settings-bar">
        <div class="max-w-7xl mx-auto px-6 flex items-center justify-end gap-4">
            <div class="settings-dropdown" id="timezoneDropdown">
                <button class="settings-btn" onclick="toggleDropdown('timezoneDropdown')">
                    <i data-lucide="clock"></i>
                    <span id="selectedTimezone">Auto</span>
                    <i data-lucide="chevron-down" class="w-3 h-3"></i>
                </button>
                <div class="dropdown-menu" id="timezoneMenu">
                    <div class="dropdown-item" data-tz="auto" onclick="setTimezone('auto', 'Auto')">Auto-detect</div>
                    <div class="dropdown-item" data-tz="Etc/GMT" onclick="setTimezone('Etc/GMT', 'UTC+0')">UTC+0</div>
                    <div class="dropdown-item" data-tz="Etc/GMT-3" onclick="setTimezone('Etc/GMT-3', 'UTC+3')">UTC+3</div>
                    <div class="dropdown-item" data-tz="Etc/GMT-8" onclick="setTimezone('Etc/GMT-8', 'UTC+8')">UTC+8</div>
                    <div class="dropdown-item" data-tz="Etc/GMT+5" onclick="setTimezone('Etc/GMT+5', 'UTC-5')">UTC-5</div>
                </div>
            </div>

            <div class="settings-dropdown" id="languageDropdown">
                <button class="settings-btn" onclick="toggleDropdown('languageDropdown')">
                    <i data-lucide="globe"></i>
                    <span id="selectedLanguage">English</span>
                    <i data-lucide="chevron-down" class="w-3 h-3"></i>
                </button>
                <div class="dropdown-menu" id="languageMenu">
                    <div class="dropdown-item selected" data-lang="en" onclick="setLanguage('en')">English</div>
                    <div class="dropdown-item" data-lang="tr" onclick="setLanguage('tr')">Türkçe</div>
                    <div class="dropdown-item" data-lang="zh" onclick="setLanguage('zh')">中文</div>
                    <div class="dropdown-item" data-lang="ja" onclick="setLanguage('ja')">日本語</div>
                    <div class="dropdown-item" data-lang="ko" onclick="setLanguage('ko')">한국어</div>
                    <div class="dropdown-item" data-lang="es" onclick="setLanguage('es')">Español</div>
                    <div class="dropdown-item" data-lang="fr" onclick="setLanguage('fr')">Français</div>
                    <div class="dropdown-item" data-lang="ru" onclick="setLanguage('ru')">Русский</div>
                </div>
            </div>
        </div>
    </div>

    <main class="flex-grow max-w-7xl mx-auto px-6 py-8 w-full">
        <div class="text-center mb-10">
            <h1 class="text-5xl font-black mb-4 bg-gradient-to-r from-white via-blue-300 to-purple-300 bg-clip-text text-transparent" data-translate="calendarTitle">Economic Calendar</h1>
            <p class="text-gray-400 text-lg font-bold" data-translate="calendarSub">Track important economic events and market-moving announcements</p>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <h2 class="calendar-title" id="currentWeek">This Week</h2>
                    <button class="filter-btn notification-toggle" onclick="toggleNotifications()" id="notificationBtn">
                        <i data-lucide="bell" class="w-4 h-4"></i>
                        <span id="notificationStatus">Off</span>
                    </button>
                </div>
                <div class="calendar-nav">
                    <button class="nav-btn" data-view="today" onclick="setDateView('today')">Today</button>
                    <button class="nav-btn active" data-view="week" onclick="setDateView('week')">This Week</button>
                    <button class="nav-btn" data-view="nextday" onclick="setDateView('nextday')">Tomorrow</button>
                    <button class="nav-btn" data-view="nextweek" onclick="setDateView('nextweek')">Next Week</button>
                </div>
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Country:</span>
                    <button class="filter-btn active" data-country="all" onclick="setCountryFilter('all')">All</button>
                    <button class="filter-btn" data-country="us" onclick="setCountryFilter('us')"><img src="https://flagcdn.com/w20/us.png" alt="US"> US</button>
                    <button class="filter-btn" data-country="eu" onclick="setCountryFilter('eu')"><img src="https://flagcdn.com/w20/eu.png" alt="EU"> EU</button>
                    <button class="filter-btn" data-country="gb" onclick="setCountryFilter('gb')"><img src="https://flagcdn.com/w20/gb.png" alt="UK"> UK</button>
                    <button class="filter-btn" data-country="jp" onclick="setCountryFilter('jp')"><img src="https://flagcdn.com/w20/jp.png" alt="JP"> JP</button>
                    <button class="filter-btn" data-country="cn" onclick="setCountryFilter('cn')"><img src="https://flagcdn.com/w20/cn.png" alt="CN"> CN</button>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Impact:</span>
                    <button class="filter-btn active" data-impact="all" onclick="setImpactFilter('all')">All</button>
                    <button class="filter-btn" data-impact="high" onclick="setImpactFilter('high')"><span class="impact-indicator impact-high"></span> High</button>
                    <button class="filter-btn" data-impact="medium" onclick="setImpactFilter('medium')"><span class="impact-indicator impact-medium"></span> Medium</button>
                    <button class="filter-btn" data-impact="low" onclick="setImpactFilter('low')"><span class="impact-indicator impact-low"></span> Low</button>
                </div>
            </div>

            <div class="event-list" id="eventList">
                <div class="no-events" id="loadingState">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin" style="margin: 0 auto 16px;"></i>
                    <p>Loading economic events...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Auth Modal (Sign Up/Sign In) -->
    <div id="authModal" class="signup-modal">
        <div class="signup-content relative signup-mode" id="authContent">
            <button class="close-btn" onclick="closeAuthModal()">
                <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            <h2 id="authTitle">Join WabbleNews</h2>
            <p id="authSubtitle">Create your account to stay updated with the latest crypto news</p>
            
            <!-- Google Sign-In Button -->
            <button type="button" class="google-btn" onclick="handleGoogleSignIn()" id="googleSignInBtn">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                <span>Continue with Google</span>
            </button>

            <div class="divider">
                <span>or</span>
            </div>

            <!-- Sign Up Form -->
            <form id="signupForm" onsubmit="handleSignUp(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required 
                        autocomplete="username"
                        placeholder="Choose a username"
                        pattern="^[a-zA-Z0-9.]+$"
                        minlength="3"
                        maxlength="20"
                    >
                    <div class="error-message" id="usernameError"></div>
            </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        autocomplete="new-password"
                        placeholder="Create a secure password"
                        minlength="8"
                        oninput="checkPasswordStrength(this.value)"
                    >
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bars">
                            <div class="strength-bar" id="bar1"><div class="fill"></div></div>
                            <div class="strength-bar" id="bar2"><div class="fill"></div></div>
                            <div class="strength-bar" id="bar3"><div class="fill"></div></div>
                            <div class="strength-bar" id="bar4"><div class="fill"></div></div>
                            <div class="strength-bar" id="bar5"><div class="fill"></div></div>
                        </div>
                        <span class="strength-label" id="strengthLabel"></span>
                    </div>
                    <div class="error-message" id="passwordError"></div>
        </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        required 
                        autocomplete="new-password"
                        placeholder="Confirm your password"
                        minlength="8"
                    >
                    <div class="error-message" id="confirmPasswordError"></div>
    </div>

                <button type="submit" class="signup-btn" id="signupSubmitBtn">Join Now</button>
                <div class="success-message" id="successMessage">Account created successfully! Welcome to WabbleNews!</div>
            </form>

            <!-- Sign In Form -->
            <form id="signinForm" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label for="signinUsername">Username</label>
                    <input 
                        type="text" 
                        id="signinUsername" 
                        name="signinUsername" 
                        required 
                        autocomplete="username"
                        placeholder="Enter your username"
                    >
                    <div class="error-message" id="signinUsernameError"></div>
                </div>
                
                <div class="form-group">
                    <label for="signinPassword">Password</label>
                    <input 
                        type="password" 
                        id="signinPassword" 
                        name="signinPassword" 
                        required 
                        autocomplete="current-password"
                        placeholder="Enter your password"
                    >
                    <div class="error-message" id="signinPasswordError"></div>
                </div>
                
                <button type="submit" class="signup-btn" id="signinSubmitBtn">Sign In</button>
            </form>

            <!-- Toggle Links -->
            <div id="toggleToSignIn" class="toggle-link">
                Have an account? <span class="sign-in-link" onclick="switchToSignIn()">Sign in</span>
                    </div>
            <div id="toggleToSignUp" class="toggle-link" style="display: none;">
                Don't have an account? <span class="sign-up-link" onclick="switchToSignUp()">Sign up</span>
                </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-content relative">
            <button class="close-btn" onclick="closeProfileModal()">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2>Profile Settings</h2>
            <p style="margin-bottom: 24px; color: #9ca3af;">Customize your profile</p>
            
            <form id="profileForm" onsubmit="handleProfileUpdate(event)">
                <div class="profile-picture-container">
                    <div class="profile-picture-wrapper">
                        <div class="profile-picture-preview" onclick="document.getElementById('profilePictureInput').click()">
                            <img id="profilePicturePreview" src="" alt="Profile" style="display: none;">
                            <i data-lucide="user" id="profilePictureIcon"></i>
                        </div>
                        <div class="profile-picture-edit-btn" onclick="document.getElementById('profilePictureInput').click()">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <label for="profilePictureInput" class="file-input-label">Change Photo</label>
                    <input type="file" id="profilePictureInput" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif" onchange="handleProfilePictureChange(event)">
                    <div class="error-message" id="profilePictureError"></div>
                </div>

                <div class="form-group">
                    <label for="profileUsername">Username</label>
                    <input 
                        type="text" 
                        id="profileUsername" 
                        name="profileUsername" 
                        placeholder="Enter your username"
                        maxlength="20"
                        pattern="^[a-zA-Z0-9.]+$"
                    >
                    <div class="error-message" id="usernameChangeError"></div>
                    <div style="margin-top: 4px;">
                        <span id="usernameChangeInfo" style="color: #9ca3af; font-size: 11px; font-weight: 700;"></span>
                    </div>
                    </div>

                <div class="form-group">
                    <label for="profileBio">Bio</label>
                    <div style="position: relative;">
                        <textarea 
                            id="profileBio" 
                            name="profileBio" 
                            placeholder="Tell us about yourself"
                            maxlength="500"
                            class="bio-textarea"
                        ></textarea>
                        <div style="text-align: right; margin-top: 6px;">
                            <span id="bioCharCount" style="color: #9ca3af; font-size: 12px; font-weight: 700;">0/500</span>
                        </div>
            </div>
        </div>

                <button type="submit" class="signup-btn">Save Changes</button>
                <button type="button" class="logout-btn" onclick="handleLogout()">Log Out</button>
            </form>
        </div>
    </div>

    <footer class="border-t border-white/10 bg-black py-10 mt-auto">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <div class="flex flex-wrap justify-center gap-4 mb-4">
                <a href="terms-of-use.html" class="text-gray-400 hover:text-white text-xs font-bold transition-colors">Terms of Use</a>
                <span class="text-gray-600">•</span>
                <a href="terms-of-service.html" class="text-gray-400 hover:text-white text-xs font-bold transition-colors">Terms of Service</a>
            </div>
            <p class="text-gray-500 text-xs font-bold mt-2">Copyright © 2025 Wabble News / Crypto Wabble. All rights reserved.</p>
        </div>
    </footer>

    <script>
        lucide.createIcons();

        let currentTimezone = localStorage.getItem('wabblenews_timezone') || 'auto';
        let currentLanguage = localStorage.getItem('wabblenews_language') || 'en';

        const translations = {
            en: { home: 'Home', contact: 'Contact', social: 'Social Media', calendar: 'Calendar', signup: 'Sign Up/Sign In', calendarTitle: 'Economic Calendar', calendarSub: 'Track important economic events and market-moving announcements' },
            tr: { home: 'Anasayfa', contact: 'İletişim', social: 'Sosyal Medya', calendar: 'Takvim', signup: 'Kayıt/Giriş', calendarTitle: 'Ekonomik Takvim', calendarSub: 'Önemli ekonomik olayları ve piyasa hareketlerini takip edin' },
            zh: { home: '首页', contact: '联系', social: '社交媒体', calendar: '日历', signup: '注册/登录', calendarTitle: '经济日历', calendarSub: '跟踪重要的经济事件和市场公告' },
            ja: { home: 'ホーム', contact: 'お問い合わせ', social: 'ソーシャルメディア', calendar: 'カレンダー', signup: '登録/ログイン', calendarTitle: '経済カレンダー', calendarSub: '重要な経済イベントと市場動向を追跡' },
            ko: { home: '홈', contact: '연락처', social: '소셜 미디어', calendar: '캘린더', signup: '가입/로그인', calendarTitle: '경제 캘린더', calendarSub: '중요한 경제 이벤트 및 시장 발표 추적' },
            es: { home: 'Inicio', contact: 'Contacto', social: 'Redes Sociales', calendar: 'Calendario', signup: 'Registrarse', calendarTitle: 'Calendario Económico', calendarSub: 'Seguimiento de eventos económicos importantes' },
            fr: { home: 'Accueil', contact: 'Contact', social: 'Réseaux Sociaux', calendar: 'Calendrier', signup: 'Inscription', calendarTitle: 'Calendrier Économique', calendarSub: 'Suivez les événements économiques importants' },
            ru: { home: 'Главная', contact: 'Контакты', social: 'Соцсети', calendar: 'Календарь', signup: 'Регистрация', calendarTitle: 'Экономический Календарь', calendarSub: 'Отслеживайте важные экономические события' }
        };

        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const menu = dropdown.querySelector('.dropdown-menu');
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('active');
            });
            menu.classList.toggle('active');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.settings-dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
            }
        });

        function setTimezone(tz, display) {
            currentTimezone = tz;
            localStorage.setItem('wabblenews_timezone', tz);
            localStorage.setItem('wabblenews_timezone_display', display || 'Auto');
            document.getElementById('selectedTimezone').textContent = display || 'Auto';
            document.querySelectorAll('#timezoneMenu .dropdown-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.tz === tz);
            });
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
            updateEventTimes();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('wabblenews_language', lang);
            const langNames = { en: 'English', tr: 'Türkçe', zh: '中文', ja: '日本語', ko: '한국어', es: 'Español', fr: 'Français', ru: 'Русский' };
            document.getElementById('selectedLanguage').textContent = langNames[lang] || 'English';
            document.querySelectorAll('#languageMenu .dropdown-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.lang === lang);
            });
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
            applyTranslations(lang);
        }

        function applyTranslations(lang) {
            const t = translations[lang] || translations.en;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (t[key]) el.textContent = t[key];
            });
        }

        function getTimezone() {
            if (currentTimezone === 'auto') {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            }
            return currentTimezone;
        }

        // State
        let currentCountryFilter = 'all';
        let currentImpactFilter = 'all';
        let currentWeekOffset = 0;
        let notificationsEnabled = localStorage.getItem('calendar_notifications') === 'true';
        let economicEvents = [];

        // FinanceFlow API
        const CALENDAR_API_KEY = CONFIG.CALENDAR_API_KEY;
        const CALENDAR_API_URL = CONFIG.CALENDAR_API_URL;

        // Country code mapping
        const countryCodeMap = {
            'United States': 'us', 'European Union': 'eu', 'United Kingdom': 'gb', 'Japan': 'jp',
            'China': 'cn', 'Germany': 'de', 'France': 'fr', 'Italy': 'it', 'Canada': 'ca',
            'Australia': 'au', 'Switzerland': 'ch', 'Brazil': 'br', 'India': 'in', 'Russia': 'ru',
            'South Korea': 'kr', 'Mexico': 'mx', 'Spain': 'es', 'Netherlands': 'nl', 'Turkey': 'tr'
        };

        // Impact mapping
        function mapImpact(impact) {
            if (!impact) return 'low';
            const lower = impact.toLowerCase();
            if (lower.includes('high') || lower.includes('major')) return 'high';
            if (lower.includes('moderate') || lower.includes('medium')) return 'medium';
            return 'low';
        }

        async function fetchCalendarEvents() {
            const container = document.getElementById('eventList');
            container.innerHTML = '<div class="no-events"><p style="color: #60a5fa;"><i data-lucide="loader-2" class="w-6 h-6 animate-spin" style="display: inline-block; margin-right: 8px;"></i>Loading events...</p></div>';
            lucide.createIcons();
            
            try {
                // Fetch 30 days of data to cover all views
                const today = new Date();
                const dateFrom = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const dateTo = new Date(today.getTime() + 21 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const url = `${CALENDAR_API_URL}?api_key=${CALENDAR_API_KEY}&date_from=${dateFrom}&date_to=${dateTo}`;
                console.log('Fetching calendar:', url.replace(CALENDAR_API_KEY, '***'));
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Calendar API response:', data);
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    economicEvents = data.data.map((event, index) => ({
                        id: index + 1,
                        name: event.report_name || 'Unknown Event',
                        country: countryCodeMap[event.country] || event.country?.toLowerCase().substring(0, 2) || 'us',
                        countryName: event.country || 'Unknown',
                        time: new Date(event.datetime),
                        impact: mapImpact(event.economicImpact),
                        forecast: event.consensus || '-',
                        previous: event.previous || '-',
                        actual: event.actual && event.actual.trim() !== '' ? event.actual : null,
                        history: []
                    }));
                    console.log('Parsed events:', economicEvents.length);
                    renderEvents();
                } else if (data.message) {
                    container.innerHTML = `<div class="no-events"><p style="color: #ef4444;">API Error: ${data.message}</p></div>`;
                } else {
                    container.innerHTML = '<div class="no-events"><p>No events returned from API</p></div>';
                }
            } catch (error) {
                console.error('Calendar API error:', error.message || error);
                // Use sample data as fallback
                const today = new Date();
                economicEvents = [
                    { id: 1, name: 'US Non-Farm Payrolls', country: 'us', countryName: 'United States', time: new Date(today.getTime() + 2 * 60 * 60 * 1000), impact: 'high', forecast: '180K', previous: '175K', actual: null },
                    { id: 2, name: 'ECB Interest Rate Decision', country: 'eu', countryName: 'European Union', time: new Date(today.getTime() + 24 * 60 * 60 * 1000), impact: 'high', forecast: '4.25%', previous: '4.50%', actual: null },
                    { id: 3, name: 'UK GDP Growth Rate', country: 'gb', countryName: 'United Kingdom', time: new Date(today.getTime() + 48 * 60 * 60 * 1000), impact: 'medium', forecast: '0.3%', previous: '0.2%', actual: null },
                    { id: 4, name: 'Japan CPI', country: 'jp', countryName: 'Japan', time: new Date(today.getTime() + 72 * 60 * 60 * 1000), impact: 'medium', forecast: '2.8%', previous: '2.7%', actual: null },
                    { id: 5, name: 'US Consumer Confidence', country: 'us', countryName: 'United States', time: new Date(today.getTime() + 96 * 60 * 60 * 1000), impact: 'low', forecast: '102.5', previous: '101.3', actual: null }
                ];
                console.log('Using sample data due to API error');
                renderEvents();
            }
        }

        function getTimezoneOffset() {
            if (currentTimezone === 'auto') return 0;
            const match = currentTimezone.match(/GMT([+-]?\d+)/);
            return match ? -parseInt(match[1]) * 60 : 0;
        }

        function formatEventTime(date) {
            const tz = getTimezone();
            return date.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: true });
        }

        function formatEventDate(date) {
            const tz = getTimezone();
            return date.toLocaleDateString('en-US', { timeZone: tz, weekday: 'long', month: 'long', day: 'numeric' });
        }

        function getCountdown(eventTime) {
            const now = Date.now();
            const diff = eventTime.getTime() - now;
            if (diff <= 0) return null;
            if (diff > 15 * 60 * 1000) return null;
            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Multi-select filter state
        let selectedCountries = new Set(['all']);
        let selectedImpacts = new Set(['all']);

        function setCountryFilter(country) {
            if (country === 'all') {
                selectedCountries.clear();
                selectedCountries.add('all');
            } else {
                selectedCountries.delete('all');
                if (selectedCountries.has(country)) {
                    selectedCountries.delete(country);
                    if (selectedCountries.size === 0) selectedCountries.add('all');
                } else {
                    selectedCountries.add(country);
                }
            }
            document.querySelectorAll('[data-country]').forEach(btn => {
                btn.classList.toggle('active', selectedCountries.has(btn.dataset.country));
            });
            renderEvents();
        }

        function setImpactFilter(impact) {
            if (impact === 'all') {
                selectedImpacts.clear();
                selectedImpacts.add('all');
            } else {
                selectedImpacts.delete('all');
                if (selectedImpacts.has(impact)) {
                    selectedImpacts.delete(impact);
                    if (selectedImpacts.size === 0) selectedImpacts.add('all');
                } else {
                    selectedImpacts.add(impact);
                }
            }
            document.querySelectorAll('[data-impact]').forEach(btn => {
                btn.classList.toggle('active', selectedImpacts.has(btn.dataset.impact));
            });
            renderEvents();
        }

        function toggleNotifications() {
            notificationsEnabled = !notificationsEnabled;
            localStorage.setItem('calendar_notifications', notificationsEnabled);
            updateNotificationUI();
            if (notificationsEnabled && 'Notification' in window) {
                Notification.requestPermission();
            }
        }

        function updateNotificationUI() {
            const btn = document.getElementById('notificationBtn');
            const status = document.getElementById('notificationStatus');
            if (notificationsEnabled) {
                btn.classList.add('active');
                status.textContent = 'On';
            } else {
                btn.classList.remove('active');
                status.textContent = 'Off';
            }
        }

        function sendNotification(title, body) {
            if (!notificationsEnabled || !('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                new Notification(title, { body, icon: 'wabble.jpg' });
            }
        }

        let currentDateView = 'week';

        function getDateRange(view) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            const dayOfWeek = today.getDay();
            const weekStart = new Date(today.getTime() - dayOfWeek * 24 * 60 * 60 * 1000);
            const weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
            const nextWeekStart = new Date(weekEnd.getTime());
            const nextWeekEnd = new Date(nextWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000);

            switch (view) {
                case 'today':
                    return { start: today, end: tomorrow };
                case 'nextday':
                    return { start: tomorrow, end: new Date(tomorrow.getTime() + 24 * 60 * 60 * 1000) };
                case 'week':
                    return { start: weekStart, end: weekEnd };
                case 'nextweek':
                    return { start: nextWeekStart, end: nextWeekEnd };
                default:
                    return { start: today, end: new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000) };
            }
        }

        function setDateView(view) {
            currentDateView = view;
            const titles = { today: 'Today', week: 'This Week', nextday: 'Tomorrow', nextweek: 'Next Week' };
            document.getElementById('currentWeek').textContent = titles[view] || 'This Week';
            document.querySelectorAll('.calendar-nav .nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            fetchCalendarEvents();
        }

        function changeWeek(delta) {
            currentWeekOffset += delta;
            document.getElementById('currentWeek').textContent = currentWeekOffset === 0 ? 'This Week' : (currentWeekOffset > 0 ? `+${currentWeekOffset} Week${currentWeekOffset > 1 ? 's' : ''}` : `${currentWeekOffset} Week${currentWeekOffset < -1 ? 's' : ''}`);
            fetchCalendarEvents();
        }

        function goToToday() {
            currentWeekOffset = 0;
            setDateView('today');
        }

        function renderEvents() {
            const container = document.getElementById('eventList');
            const dateRange = getDateRange(currentDateView);
            
            let filtered = economicEvents.filter(e => {
                // Date filter based on view
                if (e.time < dateRange.start || e.time >= dateRange.end) return false;
                // Multi-select country filter
                if (!selectedCountries.has('all') && !selectedCountries.has(e.country)) return false;
                // Multi-select impact filter
                if (!selectedImpacts.has('all') && !selectedImpacts.has(e.impact)) return false;
                return true;
            });

            filtered.sort((a, b) => a.time - b.time);

            if (filtered.length === 0) {
                const viewName = { today: 'today', week: 'this week', nextday: 'tomorrow', nextweek: 'next week' }[currentDateView] || 'selected period';
                container.innerHTML = `<div class="no-events"><p>No events for ${viewName}</p><p style="font-size: 13px; margin-top: 8px; color: #6b7280;">Try selecting a different time period or adjusting your filters</p></div>`;
                return;
            }

            const grouped = {};
            filtered.forEach(event => {
                const dateKey = formatEventDate(event.time);
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(event);
            });

            let html = '';
            for (const [date, events] of Object.entries(grouped)) {
                html += `<div class="event-day"><div class="day-header">${date}</div>`;
                events.forEach(event => {
                    const countdown = getCountdown(event.time);
                    const isUpcoming = countdown !== null;
                    const isReleased = event.actual !== null;
                    html += `<div class="event-item ${isUpcoming ? 'upcoming' : ''} ${isReleased ? 'released' : ''}">`;
                    html += `<div class="event-time-col"><span class="event-time">${formatEventTime(event.time)}</span>`;
                    if (countdown) html += `<div class="event-countdown"><i data-lucide="clock" class="w-3 h-3"></i>${countdown}</div>`;
                    html += '</div>';
                    html += `<div class="event-details"><span class="event-name">${event.name}</span>`;
                    html += `<span class="event-country"><img src="https://flagcdn.com/w20/${event.country}.png" alt="${event.country}"> ${event.countryName}</span>`;
                    if (event.history.length > 0) {
                        html += '<div class="event-history">';
                        event.history.forEach(h => { html += `<div class="history-item">${h.date}: <span>${h.value}</span></div>`; });
                        html += '</div>';
                    }
                    html += '</div>';
                    html += `<div class="event-values"><div style="font-size: 11px; color: #6b7280;">Forecast</div><div style="font-weight: 800; color: #9ca3af;">${event.forecast}</div>`;
                    if (event.actual) html += `<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Actual</div><div class="event-actual">${event.actual}</div>`;
                    html += '</div>';
                    html += `<div class="event-impact"><span class="impact-dot impact-${event.impact}"></span></div>`;
                    html += '</div>';
                });
                html += '</div>';
            }
            container.innerHTML = html;
            lucide.createIcons();
        }

        function checkNotifications() {
            if (!notificationsEnabled) return;
            const now = Date.now();
            sampleEvents.forEach(event => {
                const diff = event.time.getTime() - now;
                if (diff > 0 && diff <= 30 * 60 * 1000 && diff > 29 * 60 * 1000) {
                    sendNotification('Economic Event in 30 minutes', event.name);
                }
                if (diff > 0 && diff <= 15 * 60 * 1000 && diff > 14 * 60 * 1000) {
                    sendNotification('Economic Event in 15 minutes!', event.name);
                }
                if (diff <= 0 && diff > -60000 && !event.notified) {
                    sendNotification('Data Released!', `${event.name} has been released`);
                    event.notified = true;
                }
            });
        }

        function toggleMenu() {
            const menu = document.getElementById('mobileMenu');
            if (menu) {
                menu.classList.toggle('hidden');
                document.body.style.overflow = menu.classList.contains('hidden') ? '' : 'hidden';
            }
            lucide.createIcons();
        }
        function updateMobileMenu() {
            const currentUser = localStorage.getItem('wabblenews_current_user');
            const mobileSignUp = document.getElementById('mobileSignUpBtn');
            const mobileProfile = document.getElementById('mobileProfileBtn');
            if (currentUser) {
                if (mobileSignUp) mobileSignUp.classList.add('hidden');
                if (mobileProfile) mobileProfile.classList.remove('hidden');
            } else {
                if (mobileSignUp) mobileSignUp.classList.remove('hidden');
                if (mobileProfile) mobileProfile.classList.add('hidden');
            }
        }

        function initSettings() {
            const savedTz = localStorage.getItem('wabblenews_timezone');
            const savedTzDisplay = localStorage.getItem('wabblenews_timezone_display');
            const savedLang = localStorage.getItem('wabblenews_language');
            if (savedTz && savedTzDisplay) {
                document.getElementById('selectedTimezone').textContent = savedTzDisplay;
                document.querySelectorAll('#timezoneMenu .dropdown-item').forEach(item => {
                    item.classList.toggle('selected', item.dataset.tz === savedTz);
                });
            }
            if (savedLang) setLanguage(savedLang);
            updateNotificationUI();
            renderEvents();
        }

        function checkLoginStatus() {
            const currentUser = localStorage.getItem('wabblenews_current_user');
            if (currentUser) {
                document.getElementById('signUpBtn').classList.add('hidden');
                document.getElementById('profileBtn').classList.remove('hidden');
            }
        }

        function openAuthModal(mode = 'signup') {
            const modal = document.getElementById('authModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                if (mode === 'signin') {
                    switchToSignIn();
                } else {
                    switchToSignUp();
                }
                lucide.createIcons();
            }
        }
        function closeAuthModal() {
            const modal = document.getElementById('authModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                loadProfileData();
                lucide.createIcons();
                setTimeout(() => { updateBioCharCount(); }, 100);
            }
        }
        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // Google OAuth Configuration
        const GOOGLE_CLIENT_ID = '798158583330-a66fqrfdo8h2vqftianm89j04mt84upc.apps.googleusercontent.com';
        
        // Handle Google Sign-In
        function handleGoogleSignIn() {
            const googleBtn = document.getElementById('googleSignInBtn');
            if (googleBtn) {
                googleBtn.disabled = true;
                googleBtn.querySelector('span').textContent = 'Connecting...';
            }
            
            // Generate a random state for security
            const state = Math.random().toString(36).substring(2, 15);
            sessionStorage.setItem('google_oauth_state', state);
            
            // Get the current page URL for redirect
            const redirectUri = window.location.origin + window.location.pathname;
            
            // Build OAuth URL
            const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
            authUrl.searchParams.set('client_id', GOOGLE_CLIENT_ID);
            authUrl.searchParams.set('redirect_uri', redirectUri);
            authUrl.searchParams.set('response_type', 'token');
            authUrl.searchParams.set('scope', 'openid email profile');
            authUrl.searchParams.set('state', state);
            authUrl.searchParams.set('prompt', 'select_account');
            
            // Redirect to Google OAuth
            window.location.href = authUrl.toString();
        }
        
        // Handle OAuth callback (check URL for token on page load)
        function handleOAuthCallback() {
            const hash = window.location.hash;
            if (!hash || !hash.includes('access_token')) return;
            
            // Parse the hash fragment
            const params = new URLSearchParams(hash.substring(1));
            const accessToken = params.get('access_token');
            const state = params.get('state');
            
            // Verify state
            const savedState = sessionStorage.getItem('google_oauth_state');
            if (state !== savedState) {
                console.error('OAuth state mismatch');
                return;
            }
            sessionStorage.removeItem('google_oauth_state');
            
            // Clear the hash from URL
            history.replaceState(null, '', window.location.pathname);
            
            if (accessToken) {
                // Fetch user info from Google
                fetchGoogleUserInfo(accessToken);
            }
        }
        
        // Fetch user info from Google API
        async function fetchGoogleUserInfo(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }
                
                const userInfo = await response.json();
                
                // Create or sign in user with Google account
                handleGoogleUser(userInfo);
                
            } catch (error) {
                console.error('Error fetching Google user info:', error);
                alert('Failed to sign in with Google. Please try again.');
            }
        }
        
        // Handle Google user sign in/sign up
        function handleGoogleUser(userInfo) {
            const googleId = userInfo.id;
            const email = userInfo.email;
            const name = userInfo.name || email.split('@')[0];
            const picture = userInfo.picture || '';
            
            // Create a username from email (remove special chars)
            let username = email.split('@')[0].replace(/[^a-zA-Z0-9.]/g, '').toLowerCase();
            if (username.length < 3) username = 'user' + googleId.substring(0, 6);
            if (username.length > 20) username = username.substring(0, 20);
            
            const accounts = JSON.parse(localStorage.getItem('wabblenews_accounts') || '{}');
            
            // Check if user already exists with this Google ID
            let existingUser = null;
            for (const [key, account] of Object.entries(accounts)) {
                if (account.googleId === googleId) {
                    existingUser = key;
                    break;
                }
            }
            
            if (existingUser) {
                // User exists, sign them in
                createSession(existingUser);
                checkLoginStatus();
                closeAuthModal();
            } else {
                // New user, create account
                // Make username unique if needed
                let finalUsername = username;
                let counter = 1;
                while (accounts.hasOwnProperty(finalUsername.toLowerCase())) {
                    finalUsername = username + counter;
                    counter++;
                }
                
                accounts[finalUsername.toLowerCase()] = {
                    username: finalUsername,
                    googleId: googleId,
                    email: email,
                    createdAt: new Date().toISOString(),
                    profile: {
                        name: name,
                        bio: '',
                        picture: picture
                    }
                };
                localStorage.setItem('wabblenews_accounts', JSON.stringify(accounts));
                
                // Sign in the new user
                createSession(finalUsername);
                checkLoginStatus();
                closeAuthModal();
            }
        }
        
        // Check for OAuth callback on page load
        handleOAuthCallback();

        function switchToSignIn() {
            document.getElementById('authContent').classList.remove('signup-mode');
            document.getElementById('authContent').classList.add('signin-mode');
            document.getElementById('authTitle').textContent = 'Welcome Back';
            document.getElementById('authSubtitle').textContent = 'Sign in to your account';
            document.getElementById('toggleToSignIn').style.display = 'none';
            document.getElementById('toggleToSignUp').style.display = 'block';
            clearAllErrors();
        }

        function switchToSignUp() {
            document.getElementById('authContent').classList.remove('signin-mode');
            document.getElementById('authContent').classList.add('signup-mode');
            document.getElementById('authTitle').textContent = 'Join WabbleNews';
            document.getElementById('authSubtitle').textContent = 'Create your account to stay updated with the latest crypto news';
            document.getElementById('toggleToSignIn').style.display = 'block';
            document.getElementById('toggleToSignUp').style.display = 'none';
            clearAllErrors();
        }

        function clearAllErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('input').forEach(el => el.classList.remove('error'));
        }

        // Close modal on outside click
        const authModal = document.getElementById('authModal');
        if (authModal) {
            authModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAuthModal();
                }
            });
        }

        const profileModal = document.getElementById('profileModal');
        if (profileModal) {
            profileModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeProfileModal();
                }
            });
        }

        // Username validation
        function validateUsername(username) {
            // Can't start with underscore
            if (username.startsWith('_')) {
                return { valid: false, error: 'Username cannot start with underscore' };
            }
            
            // Only letters, digits, and dots allowed
            if (!/^[a-zA-Z0-9.]+$/.test(username)) {
                return { valid: false, error: 'Username can only contain letters, numbers, and dots' };
            }
            
            // Can't contain underscore, plus, question mark, etc.
            if (/[_+?@#$%^&*()!]/.test(username)) {
                return { valid: false, error: 'Username cannot contain special characters like _, +, ?, etc.' };
            }
            
            // Length check
            if (username.length < 3) {
                return { valid: false, error: 'Username must be at least 3 characters' };
            }
            
            if (username.length > 20) {
                return { valid: false, error: 'Username must be less than 20 characters' };
            }
            
            return { valid: true };
        }

        // Check if username exists
        function usernameExists(username) {
            const accounts = JSON.parse(localStorage.getItem('wabblenews_accounts') || '{}');
            return accounts.hasOwnProperty(username.toLowerCase());
        }

        // Hash password (simple SHA-256 hash)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Handle sign up form submission
        async function handleSignUp(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const usernameError = document.getElementById('usernameError');
            const passwordError = document.getElementById('passwordError');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const signupBtn = document.getElementById('signupSubmitBtn');
            const successMessage = document.getElementById('successMessage');
            
            // Reset errors
            clearAllErrors();
            successMessage.classList.remove('show');
            
            // Validate username
            const usernameValidation = validateUsername(username);
            if (!usernameValidation.valid) {
                usernameError.textContent = usernameValidation.error;
                usernameError.classList.add('show');
                usernameInput.classList.add('error');
                return;
            }
            
            // Check if username already exists
            if (usernameExists(username)) {
                usernameError.textContent = 'Username already taken. Please choose another.';
                usernameError.classList.add('show');
                usernameInput.classList.add('error');
                return;
            }
            
            // Validate password
            if (password.length < 8) {
                passwordError.textContent = 'Password must be at least 8 characters';
                passwordError.classList.add('show');
                passwordInput.classList.add('error');
                return;
            }
            
            // Validate confirm password
            if (password !== confirmPassword) {
                confirmPasswordError.textContent = 'Passwords do not match';
                confirmPasswordError.classList.add('show');
                confirmPasswordInput.classList.add('error');
                return;
            }
            
            // Disable button
            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating Account...';
            
            try {
                // Hash password
                const hashedPassword = await hashPassword(password);
                
                // Store account (only store hashed password, never plaintext)
                const accounts = JSON.parse(localStorage.getItem('wabblenews_accounts') || '{}');
                accounts[username.toLowerCase()] = {
                    username: username,
                    passwordHash: hashedPassword,
                    createdAt: new Date().toISOString(),
                    profile: {
                        name: '',
                        bio: '',
                        picture: ''
                    }
                };
                localStorage.setItem('wabblenews_accounts', JSON.stringify(accounts));
                
                // Auto sign in after sign up - create session
                createSession(username);
                checkLoginStatus();
                closeAuthModal();
                
                // Show success message
                successMessage.classList.add('show');
            } catch (error) {
                console.error('Sign up error:', error);
                alert('Failed to create account. Please try again.');
                signupBtn.disabled = false;
                signupBtn.textContent = 'Join Now';
            }
        }

        // Handle sign in form submission
        async function handleSignIn(event) {
            event.preventDefault();
            
            const username = document.getElementById('signinUsername').value.trim();
            const password = document.getElementById('signinPassword').value;
            const usernameError = document.getElementById('signinUsernameError');
            const passwordError = document.getElementById('signinPasswordError');
            const usernameInput = document.getElementById('signinUsername');
            const passwordInput = document.getElementById('signinPassword');
            const signinBtn = document.getElementById('signinSubmitBtn');
            
            // Reset errors
            clearAllErrors();
            
            // Validate username
            if (!username) {
                usernameError.textContent = 'Please enter your username';
                usernameError.classList.add('show');
                usernameInput.classList.add('error');
                return;
            }
            
            // Validate password
            if (!password) {
                passwordError.textContent = 'Please enter your password';
                passwordError.classList.add('show');
                passwordInput.classList.add('error');
                return;
            }
            
            // Disable button
            signinBtn.disabled = true;
            signinBtn.textContent = 'Signing In...';
            
            try {
                // Hash password to compare
                const hashedPassword = await hashPassword(password);
                
                // Get accounts from localStorage
                const accounts = JSON.parse(localStorage.getItem('wabblenews_accounts') || '{}');
                const account = accounts[username.toLowerCase()];
                
                if (!account) {
                    usernameError.textContent = 'Username not found';
                    usernameError.classList.add('show');
                    usernameInput.classList.add('error');
                    signinBtn.disabled = false;
                    signinBtn.textContent = 'Sign In';
                    return;
                }
                
                // Check password (for Google accounts, no password)
                if (account.passwordHash && account.passwordHash !== hashedPassword) {
                    passwordError.textContent = 'Incorrect password';
                    passwordError.classList.add('show');
                    passwordInput.classList.add('error');
                    signinBtn.disabled = false;
                    signinBtn.textContent = 'Sign In';
                    return;
                }
                
                // Sign in successful - create session
                createSession(username);
                checkLoginStatus();
                closeAuthModal();
                
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Failed to sign in. Please try again.');
                signinBtn.disabled = false;
                signinBtn.textContent = 'Sign In';
            }
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            const strengthBars = document.querySelectorAll('.strength-bar .fill');
            const strengthLabel = document.getElementById('strengthLabel');
            
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            // Update bars
            strengthBars.forEach((bar, index) => {
                if (index < strength) {
                    bar.style.width = '100%';
                    if (strength <= 2) bar.style.background = '#ef4444';
                    else if (strength <= 3) bar.style.background = '#f97316';
                    else if (strength <= 4) bar.style.background = '#eab308';
                    else bar.style.background = '#22c55e';
                } else {
                    bar.style.width = '0';
                }
            });
            
            // Update label
            const labels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
            strengthLabel.textContent = labels[strength - 1] || '';
        }

        // Session management
        function generateSessionToken() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        function createSession(username) {
            const token = generateSessionToken();
            const sessionData = {
                username: username.toLowerCase(),
                token: token,
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
            };
            localStorage.setItem('wabblenews_session_token', JSON.stringify(sessionData));
            localStorage.setItem('wabblenews_current_user', username.toLowerCase());
            return token;
        }

        function validateSession() {
            const sessionData = localStorage.getItem('wabblenews_session_token');
            if (!sessionData) return false;
            try {
                const session = JSON.parse(sessionData);
                const expiresAt = new Date(session.expiresAt);
                if (expiresAt < new Date()) {
                    handleLogout();
                    return false;
                }
                return true;
            } catch (e) {
                return false;
            }
        }

        // Profile functions
        function loadProfileData() {
            const currentUser = localStorage.getItem('wabblenews_current_user');
            if (!currentUser) return;
            
            const accounts = JSON.parse(localStorage.getItem('wabblenews_accounts') || '{}');
            const account = accounts[currentUser];
            
            if (account && account.profile) {
                const profile = account.profile;
                
                // Load username
                const profileUsername = document.getElementById('profileUsername');
                if (profileUsername) profileUsername.value = account.username || '';
                
                // Load bio
                const profileBio = document.getElementById('profileBio');
                if (profileBio) {
                    profileBio.value = profile.bio || '';
                    updateBioCharCount();
                }
                
                // Load profile picture
                if (profile.picture) {
                    const profileImg = document.getElementById('profilePicturePreview');
                    const profileIcon = document.getElementById('profilePictureIcon');
                    const headerImg = document.getElementById('headerProfileImg');
                    const headerIcon = document.getElementById('headerProfileIcon');
                    
                    if (profileImg) {
                        profileImg.src = profile.picture;
                        profileImg.style.display = 'block';
                    }
                    if (profileIcon) profileIcon.style.display = 'none';
                    if (headerImg) {
                        headerImg.src = profile.picture;
                        headerImg.style.display = 'block';
                    }
                    if (headerIcon) headerIcon.style.display = 'none';
                }
            }
        }

        function updateBioCharCount() {
            const bio = document.getElementById('profileBio');
            const charCount = document.getElementById('bioCharCount');
            if (bio && charCount) {
                charCount.textContent = `${bio.value.length}/500`;
            }
        }

        function handleProfileUpdate(event) {
            event.preventDefault();
            
            const currentUser = localStorage.getItem('wabblenews_current_user');
            if (!currentUser) {
                alert('Please sign in to update your profile');
                return;
            }
            
            const newUsername = document.getElementById('profileUsername').value.trim();
            const bio = document.getElementById('profileBio').value.trim();
            const btn = event.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            
            // Validate new username
            if (newUsername && newUsername !== currentUser) {
                const validation = validateUsername(newUsername);
                if (!validation.valid) {
                    document.getElementById('usernameChangeError').textContent = validation.error;
                    document.getElementById('usernameChangeError').classList.add('show');
                    return;
                }
                
                if (usernameExists(newUsername)) {
                    document.getElementById('usernameChangeError').textContent = 'Username already taken';
                    document.getElementById('usernameChangeError').classList.add('show');
                    return;
                }
            }
            
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const accounts = JSON.parse(localStorage.getItem('wabblenews_accounts') || '{}');
                const account = accounts[currentUser];
                
                if (account) {
                    // Update username if changed
                    if (newUsername && newUsername !== currentUser) {
                        accounts[newUsername.toLowerCase()] = {...account, username: newUsername};
                        delete accounts[currentUser];
                        localStorage.setItem('wabblenews_current_user', newUsername.toLowerCase());
                        createSession(newUsername);
                    }
                    
                    // Update profile
                    account.profile = account.profile || {};
                    account.profile.bio = bio;
                    
                    localStorage.setItem('wabblenews_accounts', JSON.stringify(accounts));
                    
                    // Update UI
                    checkLoginStatus();
                    loadProfileData();
                    
                    // Close modal after 1 second
                    setTimeout(() => {
                        closeProfileModal();
                        checkLoginStatus();
                        btn.textContent = originalText;
                        btn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                    }, 1000);
                }
                
                // Fallback if button not found
                alert('Profile saved successfully!');
                closeProfileModal();
                checkLoginStatus();
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Failed to save profile. Please try again.');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                document.getElementById('profilePictureError').textContent = 'File size must be less than 5MB';
                document.getElementById('profilePictureError').classList.add('show');
                return;
            }
            
            // Check file type
            if (!file.type.match('image.*')) {
                document.getElementById('profilePictureError').textContent = 'Please select an image file';
                document.getElementById('profilePictureError').classList.add('show');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgData = e.target.result;
                
                // Update preview
                const profileImg = document.getElementById('profilePicturePreview');
                const profileIcon = document.getElementById('profilePictureIcon');
                
                if (profileImg) {
                    profileImg.src = imgData;
                    profileImg.style.display = 'block';
                }
                if (profileIcon) profileIcon.style.display = 'none';
                
                // Save to profile
                const currentUser = localStorage.getItem('wabblenews_current_user');
                if (currentUser) {
                    const accounts = JSON.parse(localStorage.getItem('wabblenews_accounts') || '{}');
                    const account = accounts[currentUser];
                    
                    if (account) {
                        account.profile = account.profile || {};
                        account.profile.picture = imgData;
                        
                        localStorage.setItem('wabblenews_accounts', JSON.stringify(accounts));
                        
                        // Update header
                        const headerImg = document.getElementById('headerProfileImg');
                        const headerIcon = document.getElementById('headerProfileIcon');
                        
                        if (headerImg) {
                            headerImg.src = imgData;
                            headerImg.style.display = 'block';
                        }
                        if (headerIcon) headerIcon.style.display = 'none';
                    }
                }
                
                // Clear error
                document.getElementById('profilePictureError').classList.remove('show');
            };
            
            reader.readAsDataURL(file);
        }

        function handleLogout() {
            localStorage.removeItem('wabblenews_session_token');
            localStorage.removeItem('wabblenews_current_user');
            
            // Reset UI
            checkLoginStatus();
            closeProfileModal();
            
            // Reset auth modal to sign up mode
            switchToSignUp();
        }

        initSettings();
        checkLoginStatus();
        updateMobileMenu();
        fetchCalendarEvents();
        setInterval(fetchCalendarEvents, 300000);
        setInterval(checkNotifications, 60000);
    </script>
</body>
</html>
